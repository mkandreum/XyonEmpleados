<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>XyonEmpleados | Portal del Empleado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" href="/pwa-192x192.png">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  <div id="root"></div>
  <!-- Session guard + version auto-update: runs BEFORE any cached JS bundle loads -->
  <script>
    (function () {
      // ──────────────────────────────────────
      // 1. Cache-bust on asset version change
      // ──────────────────────────────────────
      var ASSET_VERSION = '__BUILD_VERSION__';
      function nukeCaches() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function (regs) {
            regs.forEach(function (r) { r.unregister(); });
          });
        }
        if ('caches' in window) {
          caches.keys().then(function (names) {
            names.forEach(function (n) { caches.delete(n); });
          });
        }
      }
      try {
        var stored = localStorage.getItem('asset_version');
        if (stored && stored !== ASSET_VERSION && ASSET_VERSION !== '__BUILD_' + 'VERSION__') {
          nukeCaches();
          localStorage.setItem('asset_version', ASSET_VERSION);
          // Hard reload to pick up new assets
          window.location.reload(true);
          return; // stop execution while reload happens
        }
        if (ASSET_VERSION !== '__BUILD_' + 'VERSION__') {
          localStorage.setItem('asset_version', ASSET_VERSION);
        }
      } catch (e) {
        console.warn('Cache version check failed', e);
      }

      // ──────────────────────────────────────
      // 2. Poll /api/version every 2 min to detect new deploys
      //    Works even if THIS page is served from old SW cache
      // ──────────────────────────────────────
      function checkServerVersion() {
        fetch('/api/version', { cache: 'no-store' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (!data || !data.version) return;
            var local = localStorage.getItem('asset_version') || '';
            // If server has a newer version than what we have locally
            if (local && data.version !== local) {
              console.log('[version-check] New version detected:', data.version, 'current:', local);
              localStorage.setItem('asset_version', data.version);
              nukeCaches();
              setTimeout(function () { window.location.reload(true); }, 500);
            }
          })
          .catch(function () { /* offline or api not ready yet */ });
      }
      // Check immediately on page load (after 3s to not block render)
      setTimeout(checkServerVersion, 3000);
      // Then check every 2 minutes
      setInterval(checkServerVersion, 2 * 60 * 1000);

      // ──────────────────────────────────────
      // 3. Force reload when a new SW takes control
      //    This is the KEY fix: even if this HTML is the OLD cached version,
      //    when the new SW activates (skipWaiting+clientsClaim), this listener
      //    triggers and forces a reload, which then loads fresh HTML from network.
      // ──────────────────────────────────────
      var refreshing = false;
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', function () {
          if (refreshing) return;
          refreshing = true;
          console.log('[sw] New service worker took control, reloading...');
          window.location.reload();
        });
      }

      // ──────────────────────────────────────
      // 4. Session / token expiry guard
      // ──────────────────────────────────────
      try {
        var token = localStorage.getItem('token');
        if (token) {
          var parts = token.split('.');
          if (parts.length === 3) {
            var payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            if (payload.exp && (payload.exp * 1000) < Date.now()) {
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              if (window.location.pathname !== '/login' &&
                window.location.pathname !== '/register' &&
                window.location.pathname !== '/forgot-password' &&
                window.location.pathname !== '/reset-password') {
                window.location.replace('/login?expired=1');
              }
            }
          } else {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
          }
        }
      } catch (e) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      }

    })();
  </script>
  <script type="module" src="/index.tsx?v=__BUILD_VERSION__"></script>
</body>

</html>