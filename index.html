<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>XyonEmpleados | Portal del Empleado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" href="/pwa-192x192.png">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  <div id="root"></div>
  <!-- Session guard: runs BEFORE any cached JS bundle loads -->
  <script>
    (function () {
      try {
        var token = localStorage.getItem('token');
        if (token) {
          var parts = token.split('.');
          if (parts.length === 3) {
            var payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            if (payload.exp && (payload.exp * 1000) < Date.now()) {
              // Token expired - clear session immediately
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              if (window.location.pathname !== '/login' &&
                window.location.pathname !== '/register' &&
                window.location.pathname !== '/forgot-password' &&
                window.location.pathname !== '/reset-password') {
                window.location.replace('/login?expired=1');
              }
            }
          } else {
            // Invalid token format
            localStorage.removeItem('token');
            localStorage.removeItem('user');
          }
        }
      } catch (e) {
        // If anything fails, clear potentially corrupt session
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      }

      // Force Service Worker update on every page load
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (regs) {
          for (var i = 0; i < regs.length; i++) {
            // If token is expired, we need to kill the SW to get the new version
            var token = localStorage.getItem('token');
            if (token) {
              var p = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
              if (p.exp && (p.exp * 1000) < Date.now()) {
                regs[i].unregister();
              }
            }
            regs[i].update();
          }
        });
      }
    })();
  </script>
  <script type="module" src="/index.tsx"></script>
</body>

</html>